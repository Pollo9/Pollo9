{% extends 'base_planning.html' %} {% load staticfiles %}

{% block link %}
<link href="{% static 'planning/css/custom.css' %}" rel="stylesheet" type="text/css"/>
<link href="{% static 'planning/css/datatables.css' %}" rel="stylesheet" type="text/css"/>
{% endblock %}


{% block content %}
<style>
    .dataTables_wrapper .dataTable td, .dataTables_wrapper .dataTable th {
    color: #595d6e;
}
.selected{
    color: rgb(247, 248, 250);
    background-color: rgb(128, 128, 128);;
}
.kt-switch.kt-switch--icon input:checked~span:after {
    content: '\2713'!important;
}
.kt-user-card-v2 .kt-user-card-v2__pic
{
    padding-right:0!important; 
    width: 40px;
    height: 40px;
    border-radius: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: .5rem;
    overflow: hidden;
}
.kt-user-card-v2 .kt-user-card-v2__details 
{
    width: calc(100% - 40px);
}
</style>
<div class="kt-content  kt-grid__item kt-grid__item--fluid kt-grid kt-grid--hor" id="kt_content" style="margin-top: 25px">  
    <div class="kt-container  kt-container--fluid  kt-grid__item kt-grid__item--fluid" >
        <div class="kt-portlet kt-portlet--mobile">
            <form id="form_select" method="POST" action=""> {% csrf_token %}
                <div class="kt-portlet__head kt-portlet__head--lg">
                    <div class="kt-portlet__head-label">    
                        <div class="kt-subheader   kt-grid__item" id="kt_subheader" style="position: initial;box-shadow: none;">
                            <div class="kt-subheader__main">
                                <h3 class="kt-subheader__title">Utilisateurs</h3>
                                <span class="kt-subheader__separator kt-subheader__separator--v"></span>
                                <div class="kt-subheader__group kt-hidden" id="kt_subheader_search">
                                    <span class="kt-subheader__desc" id="kt_subheader_total">1240 Total</span>            
                                </div>
                                <div class="kt-subheader__group" id="kt_subheader_group_actions">
                                    <div class="kt-subheader__desc">
                                        <span id="nombre_de_utilisateur">{{utilisateurs.count}} total</span>
                                    </div>
                                    <div id="menu_to_display" class="btn-toolbar kt-margin-l-20" style="display: none;">
                                        <div class="dropdown displayNone" id="kt_subheader_group_actions_status_change">
                                            <button type="button" class="btn btn-label-brand btn-bold btn-sm" data-toggle="dropdown" aria-expanded="false">
                                            Mettre à jour le statut
                                            </button>
                                            <div class="dropdown-menu" style="" x-out-of-boundaries="">
                                                <ul class="kt-nav">
                                                    <li class="kt-nav__section kt-nav__section--first">
                                                        <span class="kt-nav__section-text">Changer le statut:</span>
                                                    </li>
                                                    <li class="kt-nav__item">
                                                        <button style="border: none;background: none;" type="submit" href="#" class="kt-nav__link submitbutton" data-toggle="status-change" data-status="1" name="mettre_a_jour_status_active" value="mettre_a_jour_status_active">
                                                            <span class="kt-nav__link-text"><span class="kt-badge kt-badge--unified-success kt-badge--inline kt-badge--bold">Actif</span></span>
                                                        </button>
                                                    </li>
                                                    <li class="kt-nav__item">
                                                        <button style="border: none;background: none;" type="submit" href="#" class="kt-nav__link submitbutton" data-toggle="status-change" data-status="2" name="mettre_a_jour_status_inactive" value="mettre_a_jour_status_inactive">
                                                            <span class="kt-nav__link-text"><span class="kt-badge kt-badge--unified-danger kt-badge--inline kt-badge--bold">Inactif</span></span>
                                                        </button>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>             
                                        <button type="submit" class="btn btn-label-danger btn-bold btn-sm btn-icon-h submitbutton" name="supprimer_element_select" value="supprimer_element_select" id="kt_subheader_group_actions_delete_all">
                                        Supprimer
                                        </button>
                                    </div>
                                </div>
                            </div>        
                        </div>
                    </div>
                    <div class="kt-portlet__head-toolbar">
                        <div class="kt-portlet__head-wrapper">
                            <div class="kt-portlet__head-actions">
                                <button type="button" class="btn btn-brand btn-elevate btn-sm" data-toggle="modal" data-target="#add_utilisateur">+ Nouvel utilisateur</button>
                            </div>  
                        </div>
                    </div>
                </div>
                <div class="kt-portlet__body">
                    <table class="table table-striped- table-bordered table-hover table-checkable" id="kt_table">
                        <thead>
                            <tr>
                                <th>
                                    <label class="kt-checkbox kt-checkbox--single kt-checkbox--solid" for="select_all1">
                                        <input type="checkbox" id="select_all1" class="kt-group-checkable">
                                        <span></span>
                                    </label>
                                </th>
                                <th>Utilisateur</th>
                                <th>Contact</th>
                                <th>Date d'inscription</th>
                                <th>Dernière connexion</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr> 
                                <th>
                                    <label class="kt-checkbox kt-checkbox--single kt-checkbox--solid" for="select_all2">
                                        <input type="checkbox" id="select_all2" class="kt-group-checkable">
                                        <span></span>
                                    </label>
                                </th>
                                <th>Utilisateur</th>
                                <th>Contact</th>
                                <th>Date d'inscription</th>
                                <th>Dernière connexion</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </tfoot>
                        <tbody id="tbodyid"></tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="add_utilisateur" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Création d'un utilisateur</h4>
                <button type="button" class="close" id="close_modal" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form class="kt-form kt-form--label-right" method="POST" id="ajouter_utilisateur" action=''>{% csrf_token %}
                    <div class="kt-portlet__body">
                        <div class="kt-section kt-section--first">
                            <div class="kt-section__body">
                                <div class="row">
                                    <label class="col-xl-3"></label>
                                    <div class="col-lg-9 col-xl-6">
                                        <h3 class="kt-section__title kt-section__title-sm">Informations nécessaires : </h3>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-xl-3 col-lg-3 col-form-label">Nom : </label>
                                    <div class="col-lg-9 col-xl-6">
                                        <input class="form-control" type="text" name="nom_utilisateur" id="nom_utilisateur" placeholder="Doe" required="">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-xl-3 col-lg-3 col-form-label">Prénom : </label>
                                    <div class="col-lg-9 col-xl-6">
                                        <input class="form-control" type="text" name="prenom_utilisateur" id="prenom_utilisateur" placeholder="Jhon" required="">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-xl-3 col-lg-3 col-form-label">Email : </label>
                                    <div class="col-lg-9 col-xl-6">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">
                                                    <i class="icon-envelope-open"></i>
                                                </span>
                                            </div>
                                            <input type="text" class="form-control" name="email_utilisateur" id="email_utilisateur" placeholder="jhon.doe@gmail.com" required="">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-xl-3 col-lg-3 col-form-label">Téléphone : </label>
                                    <div class="col-lg-9 col-xl-6">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">
                                                    <i class="icon-phone"></i>
                                                </span>
                                            </div>
                                            <input type="text" class="form-control" name="telephone_utilisateur" id="telephone_utilisateur" placeholder="0612345678" required="">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-xl-3 col-lg-3 col-form-label">Groupe(s) : </label>
                                    <div class="col-lg-9 col-xl-6">
                                        <select class="selectpicker" id="select_group_ajout_utilisateur" multiple data-selected-text-format="count > 2" data-live-search="true" required="">
                                            {% for groupe in groupes %}
                                            <option value="{{groupe.name}}" {% if theme in actu_theme %} selected="" {% endif %}>{{groupe.name}}</option>
                                            {% endfor %}
                                        </select>

                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-xl-3 col-lg-3 col-form-label">Mail de confirmation : </label>
                                    <div class="col-lg-9 col-xl-6" style="display: flex;flex-direction: column;justify-content: center;">
                                        <div class="input-group">
                                           <span class="kt-switch kt-switch--icon">
                                                <label>
                                                    <input type="checkbox" name="" id="envoi_mail_ajout_utilisateur">
                                                    <span></span>
                                                </label>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="kt-portlet__foot">
                        <div class="kt-form__actions">
                            <div class="row">
                                <div class="col-lg-12 col-xl-12" style="display: flex;justify-content: center;">
                                    <button type="submit" name="ajouter_utilisateur" value="ajouter_utilisateur" class="btn btn-brand">Enregistrer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="modal_delete_utilisateur" class="modal fade" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Supprimer un utilisateur</h5>
            </div>
            <div class="modal-body" id="delete_message">
                Etes-vous sûr de vouloir supprimer cet élément ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="close_modal_delete_utilisateur" data-dismiss="modal">Annuler</button>
                <form id='form_delete_utilisateur' class="" method="post">{% csrf_token %}
                    <button type="submit" class="btn btn-primary" id="id_utilisateur_to_delete" name="id_utilisateur_to_delete" value="" alt="Supprimer">Supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}

<script src="{% static 'planning/js/datatables.js' %}" type="text/javascript"></script>
<script src="{% static 'planning/js/jquery.dataTables.js' %}"></script>
<script src="{% static 'planning/js/dataTables.bootstrap4.js' %}"></script>
<script src="{% static 'planning/js/table_utilisateur.js' %}"></script>
<script type="text/javascript">
    $(document).on('submit', '#ajouter_utilisateur',function(e)
    {
        var selectedValues = [];    
        $("#select_group_ajout_utilisateur :selected").each(function(){
            selectedValues.push($(this).val()); 
        });
        e.preventDefault();
        $.ajax(
        {
            type:'POST',
            url:'{% url "utilisateurs" %}',    
            data:
            {
                nom_utilisateur:$('#nom_utilisateur').val(),
                prenom_utilisateur:$('#prenom_utilisateur').val(),
                email_utilisateur:$('#email_utilisateur').val(),
                telephone_utilisateur:$('#telephone_utilisateur').val(),
                envoi_mail_ajout_utilisateur:$('#envoi_mail_ajout_utilisateur').prop("checked"),
                select_group_ajout_utilisateur:selectedValues,
                csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
                action: 'ajouter_utilisateur'
            },
            success:function(json)
            {
                document.getElementById("ajouter_utilisateur").reset();
                document.getElementById("close_modal").click();
                var date_joined = json.date_joined_utilisateur;
                var options = {year: 'numeric', month: 'long', day: 'numeric',hour: 'numeric', minute:'numeric'};
                if (date_joined != "None")
                {
                    date_joined = new Date(date_joined)
                    date_joined = date_joined.toLocaleDateString('fr-FR',options);
                }
                var badge_actif = "";
                if (json.is_active==true)
                {
                    badge_actif = `<span class="kt-badge kt-badge--info kt-badge--inline" id="active_`+json.id_utilisateur+`">Actif</span>`;
                }
                else
                {
                    badge_actif = `<span class="badge badge-secondary" id="active_`+json.id_utilisateur+`">Inactif</span>`;
                }
                var csrf = "{% csrf_token %}"
                document.getElementById("ajouter_utilisateur").reset();
                $("tbody").prepend(`
                    <tr role="row" class="odd">
                        <td>
                            <label class="kt-checkbox kt-checkbox--single kt-checkbox--solid" for="` + json.id_utilisateur + `">
                                <input type="checkbox" value="` + json.id_utilisateur + `" id="` + json.id_utilisateur + `" name="utilisateur_selectionne" class="kt-checkable">
                                <span></span>
                            </label>
                        </td>
                        <td>
                            <span>
                                <div class="kt-user-card-v2">
                                    <div class="kt-user-card-v2__pic">
                                        <span>
                                            <div class="kt-user-card-v2">
                                                <div class="kt-user-card-v2__pic" style="background-color:`+json.couleur_rdm_utilisateur+`30;">
                                                    <span style="color:`+json.couleur_rdm_utilisateur+`;font-weight:bold;">` + json.diminutif_utilisateur + `</span>
                                                </div>
                                            </div>
                                        </span>
                                    </div>
                                    <div class="kt-user-card-v2__details">
                                        <a href="/profil_utilisateur/` + json.id_utilisateur + `" class="kt-user-card-v2__name">` + json.prenom_utilisateur + ` ` + json.nom_utilisateur + `</a>
                                        <span class="kt-user-card-v2__desc">` + json.group_utilisateur + `</span>
                                    </div>
                                </div>
                            </span>
                        </td>
                        <td>
                            <a class="kt-link" href="mailto:` + json.email_utilisateur + `">` + json.email_utilisateur + `</a>
                            <br>
                            <a class="kt-link" href="tel:`+ json.telephone_utilisateur +`">` + json.telephone_utilisateur + `</a>
                        </td>
                        <td>` + date_joined + `</td>
                        <td></td>
                        <td>` + badge_actif + `</td>
                        <td>
                            <a id="button" href="/profil_utilisateur/` + json.id_utilisateur + `" class="btn btn-sm btn-clean btn-icon btn-icon-md" style="padding: 0.06rem .25rem;" title="Profil de l'utilisateur">
                                <i class="icon-eye"></i>
                            </a>
                            <a class="btn btn-sm btn-clean btn-icon btn-icon-md" style="padding: 0.06rem .25rem;" onclick="openModalDelete('` + json.nom_utilisateur + ` ` + json.prenom_utilisateur +`',` + json.id_utilisateur + `)" id="supprimer_utilisateur_` + json.id_utilisateur + `" alt="Supprimer" title="Supprimer l'utilisateur" data-id=` + json.id_utilisateur + `>
                                <i class="icon-trash"></i>
                            </a>
                        </td>
                    </tr>`
                )
                swal.fire(
                {
                    title: 'Ajouter!',
                    text: 'L\'utilisateur '+ json.prenom_utilisateur+' '+json.nom_utilisateur +' a bien été ajouter!',
                    type: 'success',
                    buttonsStyling: !1,
                    showConfirmButton: false,
                    timer: 1250,
                    confirmButtonClass: "btn btn-sm btn-bold btn-brand"
                });
            },
            error : function(xhr,errmsg,err)
            {
                $('#results').html(`
                    <div class='alert-box alert radius' data-alert>
                        Oops! We have encountered an error: ` + errmsg + `
                        <a href='#' class='close'>&times;</a>
                    </div>`); // add the error to the dom
                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });
    });
    $(document).on('submit', '#form_delete_utilisateur',function(e)
    {
        e.preventDefault();
        $.ajax(
        {
            type:'POST',
            url:'{% url "utilisateurs" %}',
            data:
            {
                id:$('#id_utilisateur_to_delete').val(),
                csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
                action: 'supprimer_utilisateur'
            },
            success:function(json)
            {
                document.getElementById("form_delete_utilisateur").reset();
                $("#supprimer_utilisateur_"+json.id_utilisateur).parent().parent().remove();
                $('#close_modal_delete_utilisateur').click();
            },
            error : function(xhr,errmsg,err)
            {
                $('#results').html(`
                    <div class='alert-box alert radius' data-alert>
                        Oops! We have encountered an error: ` + errmsg + `
                        <a href='#' class='close'>&times;</a>
                    </div>`); // add the error to the dom
                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
            }
        });
    });

    var buttonpressed;
$('.submitbutton').click(function()
    {
        buttonpressed = $(this).attr('name')

        if (buttonpressed == 'supprimer_element_select')
        {
            var titre = "Êtes-vous sûr ?";
            var texte = "Vous ne pourrez pas récupérer cet utilisateur une fois supprimer!";
            var boutonconfirmtext = 'Oui, le supprimer!';
            var boutoncanceltext = 'Non, Annuler!';
            var yesTitre = 'Supprimer!';
            var yesTexte = 'L\'utilisateur a été supprimé.';
        }
        else if (buttonpressed == 'mettre_a_jour_status_active')
        {
            var titre = "";
            var texte = "Êtes-vous sûr de mettre à jour le statut des éléments sélectionnés vers Actif?";
            var boutonconfirmtext = 'Oui, le mettre à jour!';
            var boutoncanceltext = 'Non, Annuler!';
            var yesTitre = 'Mise à jour!';
            var yesTexte = 'Les éléments ont été mis à jour.';
        }
        else if (buttonpressed == 'mettre_a_jour_status_inactive')
        {
            var titre = "";
            var texte = "Êtes-vous sûr de mettre à jour le statut des éléments sélectionnés vers Inactif?";
            var boutonconfirmtext = 'Oui, le mettre à jour!';
            var boutoncanceltext = 'Non, Annuler!';
            var yesTitre = 'Mise à jour!';
            var yesTexte = 'Les éléments ont été mis à jour.';
        }
        else
        {
            return;
        }
        document.querySelector('#form_select').addEventListener('submit', function(e)
        {
            e.preventDefault();
            var list_user = [];
            $("input[name='utilisateur_selectionne']:checked").each(function()
            {
                list_user.push(Number($(this).val()));
            });
            swal.fire(
            {
                title: titre,
                text: texte,
                icon: "question",
                showCancelButton: true,
                confirmButtonText: boutonconfirmtext,
                cancelButtonText: boutoncanceltext,
            }).then((result) => 
            {
                if (result.value)
                {
                    swal.fire(
                    {
                        title: yesTitre,
                        text: yesTexte,
                        type: 'success',
                        buttonsStyling: !1,
                        showConfirmButton: false,
                        timer: 800,
                        confirmButtonClass: "btn btn-sm btn-bold btn-brand"
                    });
                    $.ajax({
                        type:'POST',
                        url:'{% url "utilisateurs" %}',
                        data:
                        {
                            csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
                            action: buttonpressed,
                            utilisateur_selectionne: list_user
                        },
                        success: function (data)
                        {
                            document.getElementById("form_select").reset();
                            if (buttonpressed == 'supprimer_element_select')
                            {
                                for (var i = 0; i < list_user.length; i++)
                                {
                                    var input = document.getElementById(""+ list_user[i] +"");
                                    var row = input.closest('tr');
                                    row.parentNode.removeChild(row);
                                }
                            }
                            else if (buttonpressed == 'mettre_a_jour_status_active')
                            {
                                for (var i = 0; i < list_user.length; i++)
                                {
                                    var active = document.getElementById('active_'+list_user[i]);
                                    active.innerHTML = 'Actif';
                                    active.className = 'kt-badge kt-badge--info kt-badge--inline';
                                }
                            }
                            else if (buttonpressed == 'mettre_a_jour_status_inactive')
                            {
                                for (var i = 0; i < list_user.length; i++)
                                {
                                    var active = document.getElementById('active_'+list_user[i]);
                                    active.innerHTML = 'Inactif';
                                    active.className = 'badge badge-secondary';
                                }
                            }
                            var elementArray = document.getElementsByClassName("selected");
                            while (elementArray.length)
                            {
                                elementArray[0].classList.remove("selected"); 
                            }
                            var total_rows = $('input[name="utilisateur_selectionne"]').length; 
                            document.getElementById("nombre_de_utilisateur").innerHTML = total_rows+ " total";
                            document.getElementById('menu_to_display').style.display = 'none';
                        },
                        error: function(data)
                        {
                            console.log('error')
                            document.getElementById("form_select").reset();
                        }
                    });
                } 
                else if (result.dismiss === Swal.DismissReason.cancel)
                    {
                        swal.fire(
                        {
                            title: "Annuler",
                            text: "l\'utilisateur est sécurisé.",
                            type: "error",
                            buttonsStyling: !1,
                            showConfirmButton: false,
                            timer: 800,
                            confirmButtonClass: "btn btn-sm btn-bold btn-brand"
                        })
                    }

            })
        });
    })
</script>
<script type="text/javascript">
    function openModalDelete(username_utilisateur, id_utilisateur)
    {
        document.getElementById("delete_message").innerHTML = "Etes-vous sûr de vouloir supprimer " + username_utilisateur + " ?";
        document.getElementById("id_utilisateur_to_delete").value = id_utilisateur;
        $('#modal_delete_utilisateur').modal({ show: true });
    }

    function if_check(check)
    {
        if (check.checked == true)
        {
            document.getElementById("value_checkbox").innerHTML = "Actif";
        }
        else
        {
            document.getElementById("value_checkbox").innerHTML = "Inactif";
        }
    }
</script>
</script>
{% endblock %}